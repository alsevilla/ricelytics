{% extends 'main.html' %}
{% load static %}
{% block content %}
    <!-- Header --->
    <div class="jumbotron">
        <div class="jumbotron-content text-center">
            <h2>State of the Rice Sector in the Philippines</h2>
            <h1>{{ title }}</h1>
            <p>How much rice supply do we attain and utilize? Know the total supply versus utilization per year, as well as the rice supply sources and utilization accounts.</p>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div class="card-deck mb-2 text-center">
                <div class="card primary mb-4 bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title p-2">Total Supply ({{ supply_year }})</h5>
                        <h1 class="card-text font-weight-bold">{{ supply_value }}{% if supply_compare > 0 %} <i class="bi bi-caret-up-fill"></i> {% elif supply_compare < 0 %} <i class="bi bi-caret-down-fill"></i>{% else %}<i class="bi bi-dash"></i>{%endif%}</h1>
                        <div class="card-note w-50 mx-auto rounded-pill bg-warning">
                            <p class="text-white">million metric tons</p>
                        </div>
                    </div>
                </div>
                <div class="card primary mb-4 bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title p-2">Total Utilization ({{ utilization_year }})</h5>
                        <h1 class="card-text font-weight-bold">{{ utilization_value }}{% if utilization_compare > 0 %} <i class="bi bi-caret-up-fill"></i> {% elif utilization_compare < 0 %} <i class="bi bi-caret-down-fill"></i>{% else %}<i class="bi bi-dash"></i>{%endif%}</h1>
                        <div class="card-note w-50 mx-auto rounded-pill bg-warning">
                            <p class="text-white">million metric tons</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header text-center">
                    <h5 class="my-0 p-2">Total supply versus total utilization (2000-2019)</h5>
                    <p class="my-0 font-weight-normal text-muted">in million metric tons (PSA, 2020)</p>
                </div>
                <div class="card-body">
                    <div><canvas id="ctxSupply"></canvas></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header text-center">
                    <h5 class="my-0 p-2">Distribution of supply source (2000-2019)</h5>
                    <p class="my-0 font-weight-normal text-muted">in million metric tons (PSA, 2020)</p>
                </div>
                <div class="card-body">
                    <div><canvas id="ctxSupplyStack"></canvas></div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card mb-4">
                <div class="card-header text-center">
                    <h5 class="my-0 p-2">Supply utilization accounts (2000-2019)</h5>
                    <p class="my-0 font-weight-normal text-muted">in million metric tons (PSA, 2020)</p>
                </div>
                <div class="card-body">
                    <div><canvas id="ctxUtilStack"></canvas></div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block script %}
<script>
    Chart.defaults.global.responsive = true;
    Chart.defaults.global.tooltips.mode = 'index';
    Chart.defaults.global.tooltips.intersect = false;
    Chart.defaults.global.defaultFontFamily = 'Poppins';
    Chart.defaults.global.defaultFontSize = 13;
    Chart.defaults.global.animation.duration = 3000;

    var dbTotalSupply = {{ tsData|safe }};
    var dbTotalUtil = {{ tuData|safe }};
    var dbSupplySources ={{ ssData|safe }};
    var dbUseAccounts = {{ yaData|safe }};
    var curStocks = '2551.00';
    var curProduce = '12305.00';
    var curImports = '3118.00';
    var curExports = '0.00';
    var curSeeds = '228.00';
    var curFeedWastes = '800.00';
    var curProcessing = '492.00';
    var curEndStocks = '2675.00';
    var curFood = '13779.00';

    let years = [];
    let years_act = [];
    let supplies = [];
    let utils = [];
    let stocks = [];
    let locals = [];
    let imports = [];
    let exports = [];
    let seeds = [];
    let feedswastes = [];
    let processing = [];
    let endstocks = [];
    let food = [];

    try {
        dbTotalSupply.map((item) => {
            years.push(item.year);
            supplies.push(item.value);
        });
        dbTotalUtil.map((item) => {
            utils.push(item.value);
        });
        dbSupplySources.map((item) => {
            stocks.push(item.SUBeginningStocks);
            locals.push(item.SUProduction);
            imports.push(item.SUImports);
        });
        dbUseAccounts.map((item) => {
            exports.push(item.UTExports);
            seeds.push(item.UTSeeds);
            feedswastes.push(item.UTFeedsWaste);
            processing.push(item.UTProcessing);
            endstocks.push(item.UTEndingStocks);
            food.push(item.uttotalnet);
        });
    } catch (error) {
        console.log(error);
    }

    var yearsLab = [...years];
    var yearsLabAct = [...years_act];
    var totalSupply = [...supplies];
    var totalUse = [...utils];
    var totalStocks = [...stocks];
    var totalProduce = [...locals];
    var totalImports = [...imports];
    var totalExports = [...exports];
    var totalSeeds = [...seeds];
    var totalFeedsWastes = [...feedswastes];
    var totalProcessing = [...processing];
    var totalEndStocks = [...endstocks];
    var totalFood = [...food];

    /**
    ctxSupply
    ctxUtil
    */

    var SupplyUse = document.getElementById('ctxSupply').getContext('2d');

    var SupplyUseChart = new Chart(SupplyUse, {
        // The type of chart we want to create
        type: 'bar',

        // The data for our dataset
        data: {
            labels: yearsLab,
            datasets: [{
                label: 'Total Supply',
                backgroundColor: '#A6CEE3', // COLOR 1
                borderColor: '#A6CEE3', // COLOR 1
                lineTension: 0,
                type: 'line',
                fill: false,
                data: totalSupply
            }, {
                label: 'Total Utilization',
                backgroundColor: '#007FFE', // COLOR 2
                borderColor: '#007FFE', // COLOR 2
                lineTension: 0,
                type: 'line',
                fill: false,
                data: totalUse
            }]
        },

        // Configuration options go here
        options: {
            aspectRatio: 2.5,
            elements: {
                point: {
                    radius: 2
                }
            },
            scales: {
                xAxes: [{
                  display: true,
                  gridLines: {
                      color: "rgba(0, 0, 0, 0)"
                  }
                }],
                yAxes: [{
                    display: true,
                    ticks: {
                        suggestedMin: 0,
                        beginAtZero:true,
                        userCallback: function(value, index, values) {
                            value = value.toString();
                            value = value.split(/(?=(?:...)*$)/);
                            value = value.join(',');
                            return value;
                          }
                    }
                }]
            },
            legend: {
                position: 'top',
                onClick: (e) => e.stopPropagation(),
            },
            tooltips:false,
            hover: {
              animationDuration: 0
            },
            animation: {
              duration: 1,
                onComplete: function() {
                  let chartInstance = this.chart,
                      ctx = chartInstance.ctx;

                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'bottom';
                  ctx.fillStyle = '#6c757d';

                  this.data.datasets.forEach(function(dataset, i){
                    let meta = chartInstance.controller.getDatasetMeta(i);
                    meta.data.forEach(function(bar, index) {
                      let data = dataset.data[index];
                      // data = parseInt(data).toLocaleString();
                      ctx.fillText(data, bar._model.x + 0 , bar._model.y + -5);
                    });
                  });
                }
            }
        }
    });

    var SupplyStack = document.getElementById('ctxSupplyStack').getContext('2d');

    var SupplyStackChart = new Chart(SupplyStack, {

        type: 'bar',

        data: {
            labels: yearsLab,
            datasets: [{
                    label: 'Beginning Stocks',
                    backgroundColor: '#FE8100', // COLOR 1
                    borderColor: '#FE8100', // COLOR 1
                    data: totalStocks
                },
                {
                    label: 'Local Production',
                    backgroundColor: '#2037B4', // COLOR 2
                    borderColor: '#2037B4', // COLOR 2
                    data: totalProduce
                },
                {
                    label: 'Imports',
                    backgroundColor: '#A2C5AC', // COLOR 3
                    borderColor: '#A2C5AC', // COLOR 3
                    data: totalImports
                }
            ]
        },

        options: {
            aspectRatio: 2.5,
            scales: {
                xAxes: [{
                    stacked: true,
                    display: true,
                    gridLines: {
                        color: "rgba(0, 0, 0, 0)"
                    }
                }],
                yAxes: [{
                    stacked: true,
                    display: true,
                    ticks : {
                      suggestedMin: 0,
                      beginAtZero:true,
                      userCallback: function(value, index, values) {
                          value = value.toString();
                          value = value.split(/(?=(?:...)*$)/);
                          value = value.join(',');
                          return value;
                        }
                    }
                }]
            },
            legend: {
                position: 'top',
                onClick: (e) => e.stopPropagation(),
            },
            datalabels: {
                display: false
            },
            plugins: {
                labels: false
            },
            // tooltips:false,
            hover: {
              animationDuration: 0
            },
            animation: {
              duration: 1,
                onComplete: function() {
                  let chartInstance = this.chart,
                      ctx = chartInstance.ctx;

                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'bottom';
                  ctx.fillStyle = '#ffffff';

                  this.data.datasets.forEach(function(dataset, i){
                    let meta = chartInstance.controller.getDatasetMeta(i);
                    meta.data.forEach(function(bar, index) {
                      let data = dataset.data[index];
                      // data = parseInt(data).toLocaleString();
                      ctx.fillText(data, bar._model.x + 0 , bar._model.y + 15);
                    });
                  });
                }
            }
        }
    });

    var UtilStack = document.getElementById('ctxUtilStack').getContext('2d');

    var ctxUtilStackChart = new Chart(UtilStack, {

        type: 'bar',

        data: {
            labels: yearsLab,
            datasets: [{
                    label: 'Exports',
                    backgroundColor: '#FE8100', // COLOR 1
                    borderColor: '#FE8100', // COLOR 1
                    data: totalExports
                },
                {
                    label: 'Seeds',
                    backgroundColor: '#00FE7F', // COLOR 2
                    borderColor: '#00FE7F', // COLOR 2
                    data: totalSeeds
                },
                {
                    label: 'Feeds/Wastes',
                    backgroundColor: '#FE0000', // COLOR 2
                    borderColor: '#FE0000', // COLOR 2
                    data: totalFeedsWastes
                },
                {
                    label: 'Processing',
                    backgroundColor: '#04C5AC', // COLOR 2
                    borderColor: '#04C5AC', // COLOR 2
                    data: totalProcessing
                },
                {
                    label: 'Net Food Disposable',
                    backgroundColor: '#2037B4', // COLOR 3
                    borderColor: '#2037B4', // COLOR 3
                    data: totalFood
                }
            ]
        },

        options: {
          aspectRatio: 2.5,
            scales: {
                xAxes: [{
                    stacked: true,
                    display: true,
                    gridLines: {
                        color: "rgba(0, 0, 0, 0)"
                    }
                }],
                yAxes: [{
                    stacked: true,
                    display: true,
                    ticks : {
                      suggestedMin: 0,
                      beginAtZero:true,
                      userCallback: function(value, index, values) {
                          value = value.toString();
                          value = value.split(/(?=(?:...)*$)/);
                          value = value.join(',');
                          return value;
                        }
                    }

                }]
            },
            legend: {
                position: 'top',
                onClick: (e) => e.stopPropagation(),
            },
            plugins: {
                labels: false
            },
            // tooltips:false,
            hover: {
              animationDuration: 0
            },
            animation: {
              duration: 1,
                onComplete: function() {
                  let chartInstance = this.chart,
                      ctx = chartInstance.ctx;

                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'bottom';
                  ctx.fillStyle = '#ffffff';

                  this.data.datasets.forEach(function(dataset, i){
                    let meta = chartInstance.controller.getDatasetMeta(i);
                    meta.data.forEach(function(bar, index) {
                      let data = dataset.data[index];
                      // data = parseInt(data).toLocaleString();
                      ctx.fillText(data, bar._model.x + 0 , bar._model.y + 15);
                    });
                  });
                }
            }
        }
    });

</script>
{% endblock script %}
